<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Touhou Song Recognitive Test by XGN from HHS</title>
    <script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.staticfile.org/howler/2.2.1/howler.js"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="index.css">
    <script src="sourceTHB.js"></script>
    <script src="source163.js"></script>
    <script src="pack.js"></script>
    <script src="game.js"></script>
</head>

<body>
    <div class="container">
        <h1>东方原曲/同人曲/相关曲认知测试</h1>
        <i>如果遇到音频无法播放，请耐心等待加载。</i>
        <p><a href="https://github.com/XiaoGeNintendo/TouhouSongRecognitiveTest" target="_blank">GitHub</a></p>
        <hr>
        <a href="stat.html">数据统计</a>
        <hr/>

        <div id="settings">
            <h2>设置</h2>
            <br/>
            <button onclick="to('thb')" class="btn btn-secondary">使用Thwiki源（✔中文、不包含重复歌曲、ZUN曲全收录 ❌不稳定、同人曲少）</button>
            <button onclick="to('163')" class="btn btn-secondary">使用网易云音乐源（✔稳定、同人曲多 ❌日文、包含重复歌曲、缺少无专辑ZUN曲）</button>
            <br/>

            <div class="input-group" style="max-width: 300px;">
                <div class="input-group-prepend">
                    <span class="input-group-text">片段长度</span>
                </div>
                <input id="len" type="number" class="form-control" placeholder="Length in seconds" value="10">
                <div class="input-group-append">
                    <span class="input-group-text">秒</span>
                </div>
            </div>
            <br>
            <div id="fran">加载中</div>
            <br>
            <div class="card">
                <div class="card-header">
                    <span>来源详细信息</span>
                </div>
                <div id="origin-details">
                    <div class="card-body clearfix" style="padding: 5px;" id="fill">
                        加载中
                    </div>
                </div>
            </div>
            <br>
            <input id="statIn" type="checkbox" checked="true"><span>计入统计数据</span>
            <br/>
            <button onclick="SettingDone()" class="btn btn-primary">确定</button>
        </div>

        <div id="game">
            <h2>游戏</h2>
            <span>正确率: <i id="cpre">100%(0/0)</i></span>
            <br>
            <span>已选择：<i id="selected">N/A</i></span>
            <br>
            <span>正确答案：<i id="real">????</i></span>
            <br>
            <br>
            <button onclick="Play('test')" class="btn btn-primary" disabled="true" id="playbtn">
                播放片段
            </button>
            <button onclick="Play(null)" class="btn btn-secondary" id="stopbtn">
                停止播放
            </button>
            <button onclick="Confirm()" class="btn btn-success" id="confirmbtn">
                确认答案
            </button>
            <button onclick="Next()" class="btn btn-primary" disabled="true" id="nextbtn">
                下一题
            </button>
            <button onclick="Link()" class="btn btn-secondary" disabled="true" id="linkbtn">
                THWIKI链接
            </button>
            <button onclick="Play('__default')" class="btn btn-dark" id="play2btn">
                从开头播放曲目
            </button>
            <button onclick="Play('test2')" class="btn btn-dark" id="play3btn">
                从测试点前5秒开始播放
            </button>
            <button onclick="Skip()" class="btn btn-danger" id="skipbtn">
                跳过此题
            </button>

            <br><br>

            <table class="table table-bordered">
                <tr>
                    <td style="width:60%;">
                        <div id="GS"></div>
                    </td>
                    <td>
                        <div id="FS">在左边选择作品</div>
                    </td>
                </tr>
            </table>
        </div>
</body>
</div>
<script>

    function to(source){
        if(source=='163'){
            lss("source",SOURCE_163);
        }else{
            lss("source",SOURCE_THB);
        }
        alert("设置成功。请刷新！");
    }

    
    loadSong();

    var html = "";
    for (var i in songs) {
        html += '<div class="origin"><input id="inp_' + i + '" type="checkbox"><span> ' + i + '</span></div>';
    }
    $("#fill").html(html);

    html = '<button onClick="loadAll()" class="btn btn-primary">全部</button>';
    for (var i in pack) {
        html += '<button onClick="loadPack(\'' + i + '\')" class="btn btn-primary">' + i + '</button>';
    }
    html += '<button onclick="clearAll()" class="btn btn-danger">清空选择</button>'
    $("#fran").html(html);

    function loadPack(id) {
        for (var i in pack[id]) {
            document.getElementById("inp_" + pack[id][i]).checked = true;
        }
    }

    function loadAll() {
        for (var i in songs) {
            document.getElementById("inp_" + i).checked = true;
        }
    }

    function clearAll() {
        for (var i in songs) {
            document.getElementById("inp_" + i).checked = false;
        }
    }

    $('#game').hide();

    function Skip(){
        avSong.push(nowSong);
        newProb();
    }

    function SettingDone() {
        $('#settings').hide();
        $('#game').show();

        var file = "";

        for (var i in songs) {
            if (document.getElementById("inp_" + i).checked) {
                for (var j in songs[i]) {
                    avSong.push(songs[i][j]);
                }
                file += '<i class="fa fa-folder btn btn-dark" onclick="unfold(\'' + i + "')\">" + i + "</i>";
            }
        }
        $('#GS').html(file)
        newProb();
    }

    function openInNewTab(url) {
        var win = window.open(url, "_blank");
        win.focus();
    }

    function Link() {
        openInNewTab("https://thwiki.cc/" + nowSong.name.replace(" ", "_"));
    }

    function newProb() {
        selected = "N/A";
        $('#selected').text(selected);
        $('#real').text("???");
        $('#confirmbtn')[0].disabled = false;
        $('#nextbtn')[0].disabled = true;
        $('#linkbtn')[0].disabled = true;
        $('#play2btn')[0].disabled = true;
        $('#play3btn')[0].disabled = true;
        $('#skipbtn')[0].disabled = false;
        tmp = null;
        genProb();
    }

    function Play(id) {
        if (ready) {
            if(sound.playing()){
                sound.stop();
            }

            if(id!=null){
                sound.play(id);
                $('#skipbtn')[0].disabled = true;
            }

            if(tmp==null && id=="test"){
                tmp=new Date().getTime()
            }
            
        } else {
            alert("加载中");
        }
    }

    var selected = "N/A";
    var correct = 0;
    var total = 0;
    var tmp = null;

    function Next() {
        sound.stop();
        $('#playbtn').text("播放片段");
        newProb();
    }

    function Confirm() {
        $('#real').html('<b>' + nowSong.name + '</b> 来自 <b>' + nowSong.cate + "</b> 从 " + start + "秒开始");
        $('#confirmbtn')[0].disabled = true;
        $('#nextbtn')[0].disabled = false;
        $('#linkbtn')[0].disabled = false;
        $('#play2btn')[0].disabled = false;
        $('#play3btn')[0].disabled = false;
        $('#skipbtn')[0].disabled = true;
        if (selected == nowSong.name) {
            correct++;
        }

        if($("#statIn")[0].checked){
            addToStat(nowSong.name,selected,new Date().getTime()-tmp);
        }

        total++;
        $('#cpre').html((correct / total) * 100 + "%" + "(" + correct + "/" + total + ")");
    }

    function unfold(proj) {
        var file = "";

        for (var i in songs[proj]) {
            file += '<i class="fa fa-music btn btn-success" onclick="select(\'' + songs[proj][i].name + '\')">' + songs[proj][i].name + '</i><br/>';
        }
        $('#FS').html(file);
    }

    function select(song) {
        selected = song;
        $('#selected').text(song);
    }
</script>

</html>