<html>
    <head>
        <title>Touhou Song Recognitive Test By XGN from HHS</title>
        <script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.staticfile.org/howler/2.2.1/howler.js"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="source.js"></script>
    <script src="pack.js"></script>
    <script src="game.js"></script>
    </head>
    <body>
        东方原曲认知大赛<br/>
        应该是移动端友好的吧<br/>
        <hr/>
        <div id="setting">
            <h1>设置</h1>
            片段长度：<input id="len" type="number" placeholder="Length in seconds" value=10> <br/>
            
            <button onclick="clearss()" class="btn btn-danger">清空选择</button> <br/>
            快捷选择系列:
            <div id="fran">加载中</div> <br/>

            选择作品：
            <div id="fill">加载中</div>
            <button onclick="SettingDone()" class="btn btn-primary">确定</button>
        </div>

        <div id="game">
            <h1>游戏</h1>
            正确率: <i id="cpre">100%(0/0)</i> <br/>
            已选择：<i id="selected">N/A</i> <br/>
            正确答案：<i id="real">????</i> <br/>
            <button onclick="Play('test')" class="btn btn-primary" disabled="true" id="playbtn">播放片段</button>
            <button onclick="Confirm()" class="btn btn-success" id="confirmbtn">确认答案</button>
            <button onclick="Next()" class="btn btn-primary" disabled="true" id="nextbtn">下一题</button>
            <button onclick="Link()" class="btn btn-secondary" disabled="true" id="linkbtn">THWIKI链接</button>
            <button onclick="Play('__default')" class="btn btn-dark" id="play2btn">从开头播放曲目</button>
            <button onclick="Play('test2')" class="btn btn-dark" id="play3btn">从测试点前5秒开始播放</button>
            
            <br/>
            
            <table border="1">
                <tr>
                    <td>
                        <div id="GS">
                        </div>
                    </td>
                    <td>
                        <div id="FS">
                            在左边选择作品
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </body>

    <script>
        loadSong()


        var html=""
        for(var i in songs){
            html+="<input id=\"inp_"+i+"\" type=\"checkbox\">"+i+"  "
        }
        document.getElementById("fill").innerHTML=html

        html=""
        for(var i in pack){
            html+='<button onClick="loadPack(\''+i+'\')" class="btn btn-primary">'+i+'</button>'
        }
        document.getElementById("fran").innerHTML=html

        function loadPack(id){
            for(var i in pack[id]){
                document.getElementById("inp_"+pack[id][i]).checked=true
            }
        }

        function clearss(){
            for(var i in songs){
                document.getElementById("inp_"+i).checked=false
            }
        }

        document.getElementById("game").style.display="none"

        function SettingDone(){
            document.getElementById("setting").style.display="none"
            document.getElementById("game").style.display="block"

            var file=""

            for(var i in songs){
                if(document.getElementById("inp_"+i).checked){
                    for(var j in songs[i]){
                        avSong.push(songs[i][j])
                    }
                    file+='<i class="fa fa-folder btn btn-dark" onclick="unfold(\''+i+'\')">'+i+'</i><br/><br/>'
                }
            }
            document.getElementById("GS").innerHTML=file

            newProb()
        }

        function openInNewTab(url) {
            var win = window.open(url, '_blank');
            win.focus();
        }

        function Link(){
            openInNewTab("https://thwiki.cc/"+nowSong.name.replace(" ","_"))
        }
        function newProb(){
            selected="N/A"
            document.getElementById("selected").innerHTML=selected
            document.getElementById("real").innerHTML="???"
            document.getElementById("confirmbtn").disabled=false
            document.getElementById("nextbtn").disabled=true
            document.getElementById("linkbtn").disabled=true
            document.getElementById("play2btn").disabled=true
            document.getElementById("play3btn").disabled=true
            genProb()
        }

        function Play(id){
            if(ready){
                if(sound.playing()){
                    sound.stop()
                }else{
                    sound.play(id)
                }
            }else{
                alert("加载中")
            }
        }

        var selected="N/A"
        var correct=0
        var total=0

        function Next(){
            sound.stop()
            newProb();
        }

        function Confirm(){
            document.getElementById("real").innerHTML=nowSong.name+" 来自 "+nowSong.cate+" 从 "+start+"秒"
            document.getElementById("confirmbtn").disabled=true
            document.getElementById("nextbtn").disabled=false
            document.getElementById("linkbtn").disabled=false
            document.getElementById("play2btn").disabled=false
            document.getElementById("play3btn").disabled=false
            if(selected==nowSong.name){
                correct++;
            }
            total++;

            document.getElementById("cpre").innerHTML=correct/total*100+"%"+"("+correct+"/"+total+")"
        }

        function unfold(proj){
            var file=""

            for(var i in songs[proj]){
                file+='<i class="fa fa-music btn btn-success" onclick="select(\''+songs[proj][i].name+'\')">'+songs[proj][i].name+"</i><br/>"
            }

            document.getElementById("FS").innerHTML=file
        }


        function select(song){
            selected=song
            document.getElementById("selected").innerHTML=song
        }
    </script>
</html>